name: Deploy Frontend

on:
  push:
    branches: [ "main" ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Build Tailwind CSS
      run: npm run build:css

    - name: Create runtime env (API_BASE)
      run: |
        mkdir -p js || true
        echo "window.__API_BASE = '${{ secrets.API_BASE || 'http://localhost:8080' }}';" > js/env.js

    - name: Compactar Arquivos do Site
      run: zip -r site.zip .

    - name: SCP para o Servidor
      uses: appleboy/scp-action@master
      with:
            host: ${{ secrets.HOST }}
            username: ${{ secrets.USERNAME }}
            key: ${{ secrets.SSH_PRIVATE_KEY }}
            port: ${{ secrets.PORT }}
            source: "site.zip"
            target: "/home/opc"

    - name: Deploy no Servidor
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          # Descompacta o zip, sobrescrevendo arquivos existentes
          sudo unzip -o /home/opc/site.zip -d /usr/share/nginx/html/
          # Remove o arquivo zip após o deploy
          rm /home/opc/site.zip
          # Garante as permissões corretas (opcional, mas recomendado)
          sudo chmod -R 755 /usr/share/nginx/html
          sudo restorecon -Rv /usr/share/nginx/html