name: Deploy Frontend

on:
  push:
    branches: [ "main" ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Compactar Arquivos do Site
      run: zip -r site.zip .

    - name: SCP para o Servidor
      uses: appleboy/scp-action@master
      with:
            host: ${{ secrets.HOST }}
            username: ${{ secrets.USERNAME }}
            key: ${{ secrets.SSH_PRIVATE_KEY }}
            port: ${{ secrets.PORT }}
            source: "site.zip"
            target: "/home/opc"

    - name: Deploy no Servidor
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          # Descompacta o zip, sobrescrevendo arquivos existentes
          unzip -o /home/opc/site.zip -d /usr/share/nginx/html/
          # Remove o arquivo zip após o deploy
          rm /home/opc/site.zip
          # Garante as permissões corretas (opcional, mas recomendado)
          sudo chmod -R 755 /usr/share/nginx/html
          sudo restorecon -Rv /usr/share/nginx/html